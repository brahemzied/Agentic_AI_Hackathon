FROM n8nio/n8n:latest

USER root

# Add the dev headers needed to build wheels on Alpine
RUN apk add --no-cache \
      python3 py3-pip py3-virtualenv \
      build-base git postgresql-dev bash \
      python3-dev musl-dev linux-headers openssl-dev libffi-dev

# Create a venv and install your packages
ENV VIRTUAL_ENV=/opt/py
ENV PATH="$VIRTUAL_ENV/bin:${PATH}" \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1

RUN python3 -m venv "$VIRTUAL_ENV" \
 && python -m pip install --upgrade pip \
 && python -m pip install "openmetadata-ingestion[dbt,postgres]==1.9.11" \
 && python -m pip install "dbt-postgres" \
 && ln -sf "$VIRTUAL_ENV/bin/pip" /usr/local/bin/pip \
 && ln -sf "$VIRTUAL_ENV/bin/python" /usr/local/bin/python \
 && ln -sf "$VIRTUAL_ENV/bin/dbt" /usr/local/bin/dbt \
 && ln -sf "$VIRTUAL_ENV/bin/metadata" /usr/local/bin/metadata
RUN apt-get update \
 && apt-get install -y --no-install-recommends postgresql-client \
 && rm -rf /var/lib/apt/lists/*

# (Optional) make sure node user can read/execute the venv
RUN chmod -R a+rx /opt/py

USER node
